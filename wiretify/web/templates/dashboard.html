{{define "content"}}
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <!-- Page Header -->
    <div class="flex justify-between items-start mb-6">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Machines</h1>
                <span class="flex h-2 w-2 relative">
                    <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                <span class="text-[10px] font-bold text-green-600 uppercase tracking-widest">Live</span>
            </div>
            <p class="text-sm text-gray-500 mt-1">Manage the devices connected to your tailnet. <a href="#"
                    class="text-blue-600 hover:underline">Learn more</a></p>
        </div>
        <button onclick="openModal()"
            class="bg-[#4b6bfb] hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium text-sm flex items-center gap-1 transition-colors">
            Add device
            <svg class="w-4 h-4 ml-1 opacity-70 border-l border-blue-400 pl-1" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
    </div>

    <!-- Toolbar (Search & Filter) -->
    <div class="flex gap-3 mb-6">
        <div class="relative flex-1 max-w-2xl">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <input type="text"
                class="block w-full pl-9 pr-3 py-2 border border-gray-300 rounded-md text-sm bg-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Search by name, owner, tag, version...">
        </div>
        <button
            class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-50 flex items-center gap-2 text-sm font-medium transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
                </path>
            </svg>
            Filters
        </button>
    </div>

    <!-- Main Content Area -->
    <div id="peer-list">
        <!-- Loading state -->
        <div class="animate-pulse flex space-x-4 border border-gray-200 rounded-lg p-6">
            <div class="flex-1 space-y-4 py-1">
                <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
            </div>
        </div>
    </div>
</main>

<!-- Modal for New Device -->
<div id="modal" class="hidden fixed inset-0 bg-gray-900/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-8 rounded-xl w-full max-w-md shadow-2xl border border-gray-100">
        <h2 class="text-xl font-bold mb-1 text-gray-900">Add device</h2>
        <p class="text-sm text-gray-500 mb-6">Create a new WireGuard peer to connect to your network.</p>

        <label class="block text-sm font-medium text-gray-700 mb-1">Device Name</label>
        <input type="text" id="peer-name" placeholder="e.g. John-MacBook"
            class="w-full bg-white border border-gray-300 rounded-md p-2.5 mb-5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">

        <!-- Icon Picker -->
        <label class="block text-sm font-medium text-gray-700 mb-2">Device Icon</label>
        <div class="grid grid-cols-3 gap-3 mb-6" id="icon-picker">
            <button onclick="selectIcon('windows', this)"
                class="icon-btn border border-gray-200 rounded-lg p-2 flex flex-col items-center gap-1 hover:bg-gray-50 transition-all">
                <svg class="w-6 h-6 text-[#0078d4]" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699m10.949-7.949H24V24l-13.051-1.8Z" />
                </svg>
                <span class="text-[10px] font-medium">Windows</span>
            </button>
            <button onclick="selectIcon('linux', this)"
                class="icon-btn border border-gray-200 rounded-lg p-2 flex flex-col items-center gap-1 hover:bg-gray-50 transition-all">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12.44,1.4C12,1.26,11.51,1.15,11,1.07V1.04C10.74,1,10.47,1,10.2,1,7.21,1,4.78,3.43,4.78,6.41c0,.2,0,.41,.03,.61C4.3,7.69,4,8.44,4,9.22c0,3,2,5.54,4.72,6.4,0,0,0,0,0,0-.4,1.21-2.18,1.6-3.48,1.86C4.4,17.65,4,18,4,18.44V20a2.02,2.02,0,0,0,.59,1.41A1.97,1.97,0,0,0,6,22H18a1.97,1.97,0,0,0,1.41-.59A2.02,2.02,0,0,0,20,20V18.44c0-.42-.31-.76-.73-.83-1.3-.26-3.08-.65-3.48-1.86,0,0,0,0,0,0,2.72-.86,4.72-3.4,4.72-6.4,0-.73-.26-1.42-.71-1.97.03-.23.04-.47.04-.71,0-2.98-2.43-5.41-5.41-5.41Z" />
                </svg>
                <span class="text-[10px] font-medium">Linux</span>
            </button>
            <button onclick="selectIcon('macos', this)"
                class="icon-btn border border-gray-200 rounded-lg p-2 flex flex-col items-center gap-1 hover:bg-gray-50 transition-all">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm-2-12h4v1h-4v-1zm0 3h4v1h-4v-1zm0 3h4v1h-4v-1z" />
                </svg>
                <span class="text-[10px] font-medium">macOS</span>
            </button>
            <button onclick="selectIcon('apple', this)"
                class="icon-btn border border-gray-200 rounded-lg p-2 flex flex-col items-center gap-1 hover:bg-gray-50 transition-all">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M18.71 19.5c-.83 1.24-1.71 2.45-3.1 2.48-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z" />
                </svg>
                <span class="text-[10px] font-medium">Apple</span>
            </button>
            <button onclick="selectIcon('android', this)"
                class="icon-btn border border-gray-200 rounded-lg p-2 flex flex-col items-center gap-1 hover:bg-gray-50 transition-all">
                <svg class="w-6 h-6 text-[#a4c639]" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M17.523 15.3414C17.523 15.7725 17.1725 16.123 16.7414 16.123C16.3103 16.123 15.9598 15.7725 15.9598 15.3414C15.9598 14.9103 16.3103 14.5598 16.7414 14.5598C17.1725 14.5598 17.523 14.9103 17.523 15.3414ZM8.0402 15.3414C8.0402 15.7725 7.6897 16.123 7.2586 16.123C6.8275 16.123 6.477 15.7725 6.477 15.3414C6.477 14.9103 6.8275 14.5598 7.2586 14.5598C7.6897 14.5598 8.0402 14.9103 8.0402 15.3414ZM19.236 11.2359L21.1437 7.9354C21.2828 7.6961 21.199 7.388 20.9597 7.2489C20.7204 7.1098 20.4124 7.1936 20.2733 7.4329L18.3375 10.7818C16.6341 10.0076 14.7118 9.5693 12.6 9.5693C10.4882 9.5693 8.5659 10.0076 6.8625 10.7818L4.9267 7.4329C4.7876 7.1936 4.4795 7.1098 4.2402 7.2489C4.0009 7.388 3.9171 7.6961 4.0562 7.9354L5.964 11.2359C3.1206 12.637 1.1818 15.4243 1.1818 18.7182H22.8182C22.8182 15.4243 20.8794 12.637 18.036 11.2359L19.236 11.2359Z" />
                </svg>
                <span class="text-[10px] font-medium">Android</span>
            </button>
            <button onclick="selectIcon('synology', this)"
                class="icon-btn border border-gray-200 rounded-lg p-2 flex flex-col items-center gap-1 hover:bg-gray-50 transition-all">
                <svg class="w-6 h-6 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M4 4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H4zm1 2h14v10H5V6zm2 2v2h2V8H7zm3 0v2h2V8h-2zm3 0v2h2V8h-2zm-6 3v2h2v-2H7zm3 0v2h2v-2h-2zm3 0v2h2v-2h-2z" />
                </svg>
                <span class="text-[10px] font-medium">Synology</span>
            </button>
        </div>

        <!-- Exit Node Toggle -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <label class="block text-sm font-medium text-gray-700">Exit Node</label>
                <span class="text-xs text-gray-500 block mt-1">Route all device internet traffic through this
                    server.</span>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="peer-exit-node" class="sr-only peer">
                <div
                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#4b6bfb]">
                </div>
            </label>
        </div>

        <div class="flex justify-end gap-3 mt-2">
            <button onclick="closeModal()"
                class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 bg-gray-50 hover:bg-gray-100 rounded-md transition-colors border border-gray-200">Cancel</button>
            <button onclick="createPeer()"
                class="bg-[#4b6bfb] hover:bg-blue-700 px-5 py-2 text-sm rounded-md font-medium text-white transition-colors">Add
                device</button>
        </div>
    </div>
</div>

<template id="empty-state-tpl">
    <div
        class="empty-banner relative rounded-xl border border-blue-100 p-10 overflow-hidden flex flex-col justify-center min-h-[220px]">
        <div class="relative z-10 max-w-md">
            <h2 class="text-xl font-bold text-gray-900 mb-3">Add your first device</h2>
            <p class="text-sm text-gray-600 mb-6">The magic of Wiretify happens when it's installed on multiple
                devices.</p>
            <button onclick="openModal()"
                class="bg-[#4b6bfb] hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium text-sm inline-flex items-center gap-1 transition-colors">
                Add device
                <svg class="w-4 h-4 ml-1 opacity-70 border-l border-blue-400 pl-1" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
        </div>

        <!-- Geometric Pattern matching exact style -->
        <div class="geo-pattern flex flex-wrap content-end justify-end gap-0.5">
            <!-- Row 1 -->
            <div class="w-16 h-16 rounded-tl-full bg-[#1e293b]"></div>
            <!-- Row 2 -->
            <div class="w-16 h-16 rounded-full bg-[#bfdbfe]"></div>
            <div class="w-16 h-16 rounded-bl-full bg-[#2dd4bf]"></div>
            <div class="w-16 h-16 rounded-tr-full bg-[#4b6bfb]"></div>
            <!-- Row 3 -->
            <div class="w-16 h-16 rounded-tr-full bg-[#1e293b]"></div>
            <div class="w-16 h-16 rounded-full bg-[#bfdbfe]"></div>
            <div class="w-16 h-16 rounded-full bg-[#1e293b]"></div>
            <div class="w-16 h-16 rounded-tl-full bg-[#bfdbfe]"></div>
            <!-- Row 4 -->
            <div class="w-16 h-16 rounded-full bg-[#1e293b]"></div>
            <div class="w-16 h-16 rounded-full bg-[#bfdbfe]"></div>
            <div class="w-16 h-16 rounded-br-full bg-[#1e293b]"></div>
            <div class="w-16 h-16 rounded-bl-full bg-[#bfdbfe]"></div>
            <div class="w-16 h-16 rounded-tl-full bg-[#1e293b]"></div>
        </div>
    </div>
</template>

<script>
    async function fetchPeers() {
        try {
            const res = await fetch('/api/peers');
            const data = await res.json();
            const container = document.getElementById('peer-list');

            if (data.length === 0) {
                const template = document.getElementById('empty-state-tpl');
                container.innerHTML = '';
                container.appendChild(template.content.cloneNode(true));
                return;
            }

            // Standard List View (Tailscale style table)
            container.innerHTML = `
                <div class="bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Machine Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">IP Address</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${data.map(peer => `
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="relative flex-shrink-0 h-8 w-8 text-gray-400 bg-gray-100 rounded-md flex items-center justify-center">
                                                ${renderPeerIcon(peer.icon)}
                                                <div class="absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-white ${peer.connected ? 'bg-green-500' : 'bg-red-400'} ${peer.connected ? 'animate-pulse' : ''}" title="${peer.connected ? 'Online' : 'Offline'}"></div>
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-semibold text-gray-900">${peer.name}</div>
                                                <div class="text-xs text-gray-500 font-mono mt-0.5" title="${peer.public_key}">${peer.public_key.substring(0, 15)}...</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex flex-col items-start gap-1">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 font-mono">
                                                ${peer.allowed_ips}
                                            </span>
                                            <span class="text-[11px] text-gray-400 font-medium flex items-center gap-2">
                                                <span class="flex items-center gap-0.5">
                                                    <svg class="w-3 h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                                                    ${(peer.rx_bytes / 1024 / 1024).toFixed(2)} MB
                                                    <span class="text-[10px] text-blue-500 font-bold ml-0.5">${calculateSpeed(peer.id, peer.rx_bytes, 'rx')}</span>
                                                </span>
                                                <span class="flex items-center gap-0.5">
                                                    <svg class="w-3 h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                                                    ${(peer.tx_bytes / 1024 / 1024).toFixed(2)} MB
                                                    <span class="text-[10px] text-purple-500 font-bold ml-0.5">${calculateSpeed(peer.id, peer.tx_bytes, 'tx')}</span>
                                                </span>
                                            </span>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex items-center justify-end gap-2">
                                            <a href="/api/peers/${peer.id}/config" download="${peer.name}.conf" class="text-gray-400 hover:text-blue-600 transition-colors" title="Download Config">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                            </a>
                                            <button onclick="deletePeer(${peer.id})" class="text-gray-400 hover:text-red-600 transition-colors" title="Remove device">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } catch (err) {
            console.error("Failed to fetch peers", err);
        }
    }

    let selectedIcon = 'linux';

    function selectIcon(icon, btn) {
        selectedIcon = icon;
        document.querySelectorAll('.icon-btn').forEach(b => {
            b.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50', 'border-blue-500');
        });
        btn.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50', 'border-blue-500');
    }

    function renderPeerIcon(iconSlug) {
        const icons = {
            linux: `<svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="currentColor"><path d="M12.44,1.4C12,1.26,11.51,1.15,11,1.07V1.04C10.74,1,10.47,1,10.2,1,7.21,1,4.78,3.43,4.78,6.41c0,.2,0,.41,.03,.61C4.3,7.69,4,8.44,4,9.22c0,3,2,5.54,4.72,6.4,0,0,0,0,0,0-.4,1.21-2.18,1.6-3.48,1.86C4.4,17.65,4,18,4,18.44V20a2.02,2.02,0,0,0,.59,1.41A1.97,1.97,0,0,0,6,22H18a1.97,1.97,0,0,0,1.41-.59A2.02,2.02,0,0,0,20,20V18.44c0-.42-.31-.76-.73-.83-1.3-.26-3.08-.65-3.48-1.86,0,0,0,0,0,0,2.72-.86,4.72-3.4,4.72-6.4,0-.73-.26-1.42-.71-1.97.03-.23.04-.47.04-.71,0-2.98-2.43-5.41-5.41-5.41Z"/></svg>`,
            windows: `<svg class="w-5 h-5 text-[#0078d4]" viewBox="0 0 24 24" fill="currentColor"><path d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699m10.949-7.949H24V24l-13.051-1.8Z"/></svg>`,
            macos: `<svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm-2-12h4v1h-4v-1zm0 3h4v1h-4v-1zm0 3h4v1h-4v-1z"/></svg>`,
            apple: `<svg class="w-5 h-5 text-gray-800" viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.1 2.48-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>`,
            android: `<svg class="w-5 h-5 text-[#a4c639]" viewBox="0 0 24 24" fill="currentColor"><path d="M17.523 15.3414C17.523 15.7725 17.1725 16.123 16.7414 16.123C16.3103 16.123 15.9598 15.7725 15.9598 15.3414C15.9598 14.9103 16.3103 14.5598 16.7414 14.5598C17.1725 14.5598 17.523 14.9103 17.523 15.3414ZM8.0402 15.3414C8.0402 15.7725 7.6897 16.123 7.2586 16.123C6.8275 16.123 6.477 15.7725 6.477 15.3414C6.477 14.9103 6.8275 14.5598 7.2586 14.5598C7.6897 14.5598 8.0402 14.9103 8.0402 15.3414ZM19.236 11.2359L21.1437 7.9354C21.2828 7.6961 21.199 7.388 20.9597 7.2489C20.7204 7.1098 20.4124 7.1936 20.2733 7.4329L18.3375 10.7818C16.6341 10.0076 14.7118 9.5693 12.6 9.5693C10.4882 9.5693 8.5659 10.0076 6.8625 10.7818L4.9267 7.4329C4.7876 7.1936 4.4795 7.1098 4.2402 7.2489C4.0009 7.388 3.9171 7.6961 4.0562 7.9354L5.964 11.2359C3.1206 12.637 1.1818 15.4243 1.1818 18.7182H22.8182C22.8182 15.4243 20.8794 12.637 18.036 11.2359L19.236 11.2359Z"/></svg>`,
            synology: `<svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H4zm1 2h14v10H5V6zm2 2v2h2V8H7zm3 0v2h2V8h-2zm3 0v2h2V8h-2zm-6 3v2h2v-2H7zm3 0v2h2v-2h-2zm3 0v2h2v-2h-2z"/></svg>`,
            default: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>`
        };
        return icons[iconSlug] || icons.default;
    }

    function openModal() {
        const modal = document.getElementById('modal');
        modal.classList.remove('hidden');
        document.getElementById('peer-name').focus();
        // Reset icon selection
        const firstIcon = document.querySelector('#icon-picker .icon-btn');
        if (firstIcon) firstIcon.click();
    }
    function closeModal() {
        const modal = document.getElementById('modal');
        modal.classList.add('hidden');
        document.getElementById('peer-name').value = '';
        document.getElementById('peer-exit-node').checked = false;
    }

    async function createPeer() {
        const nameField = document.getElementById('peer-name');
        const toggleField = document.getElementById('peer-exit-node');
        const name = nameField.value.trim();
        const useExitNode = toggleField.checked;

        if (!name) return;

        try {
            await fetch('/api/peers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, use_as_exit_node: useExitNode, icon: selectedIcon })
            });
            closeModal();
            fetchPeers();
        } catch (e) {
            alert("Error creating peer");
        }
    }

    async function deletePeer(id) {
        if (!confirm('Are you sure you want to remove this device?')) return;
        try {
            await fetch('/api/peers/' + id, { method: 'DELETE' });
            fetchPeers();
        } catch (err) {
            console.error("Failed to delete peer", err);
        }
    }

    // Allow pressing Enter in Modal
    document.getElementById('peer-name').addEventListener('keyup', function (e) {
        if (e.key === 'Enter') createPeer();
    });

    let lastStats = {}; // {id: {rx, tx, ts}}

    function calculateSpeed(id, currentBytes, type) {
        const now = Date.now();
        if (!lastStats[id]) {
            lastStats[id] = { rx: 0, tx: 0, ts: now };
        }

        const prev = lastStats[id];
        const dt = (now - prev.ts) / 1000; // seconds
        let speed = 0;

        if (dt > 0) {
            const diff = currentBytes - prev[type];
            speed = diff / dt;
        }

        // Update for next cycle after ALL calls for this peer are done
        // We'll update the timestamp and bytes at the end of fetchPeers loop or rely on the order
        if (type === 'tx') { // Assuming tx is called last
            lastStats[id].rx = lastStats[id].temp_rx || lastStats[id].rx;
            lastStats[id].tx = currentBytes;
            lastStats[id].ts = now;
        } else {
            lastStats[id].temp_rx = currentBytes;
        }

        if (speed <= 0) return '';

        if (speed < 1024) return `(${speed.toFixed(0)} B/s)`;
        if (speed < 1024 * 1024) return `(${(speed / 1024).toFixed(1)} KB/s)`;
        return `(${(speed / (1024 * 1024)).toFixed(1)} MB/s)`;
    }

    fetchPeers();
    // Realtime polling every 5 seconds
    setInterval(fetchPeers, 5000);
</script>
{{end}}